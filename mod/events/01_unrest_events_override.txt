
namespace = unrest
# Renamed id = unrest.157	to id = unrest.1571 to avoid conflict with new v3.4 vanilla event.
# Renamed id = unrest.159	to id = unrest.1591 to avoid conflict with new v3.4 vanilla event.
@unrest_event_cooldown = 360
# Fires for each planet every year (counting up from colonisation date, includes home planet)
# on_colony_yearly_pulse
planet_event = {
	id = unrest.50
	is_triggered_only = yes
	hide_window = yes

	pre_triggers = {
		has_owner = yes
		is_occupied_flag = no
		has_ground_combat = no
	}

	trigger = {
		can_generate_trade_value = yes
		NOR = {
			is_planet_class = pc_cosmogenesis_world
			planet_stability >= @stabilitylevel2
			sapient_pop_amount < 1000
			has_orbital_bombardment = yes
			# owner = { any_situation = { is_situation_type = situation_planetary_revolt } }
			has_planet_flag = 3_year_owner_change_flag
			has_planet_flag = recent_revolt_attempt
			is_doomsday_planet = yes
		}
		exists = controller
		controller = { is_same_empire = root.owner }
		OR = {
			owner = { is_gestalt = yes }
			any_owned_species = { species_has_happiness_with_owner = root.owner }
		}
		NOT = { owner = { has_active_event = { unrest.55 } } }
		check_variable_arithmetic = { # Will the revolt actually tick up?
			which = value:potential_revolt_situation_monthly_progress_estimation
			value > 0
		}
	}

	immediate = {
		set_timed_planet_flag = { flag = unrest_timer days = @unrest_event_cooldown }
		if = { # Getting an impossible to prevent revolt due to culture shock is a bit harsh. (Planet can start with no jobs, for instance)
			limit = { has_culture_shock = yes }
			planet_event = { id = unrest.54 days = 1880 random = 180 } # At least 8 years after owner change (including the 3 years via 3_year_owner_change_flag)
		}
		else = {
			planet_event = { id = unrest.54 days = 300 random = 59 } # Definitely within the next year
		}
	}
}

planet_event = {
	id = unrest.54
	is_triggered_only = yes
	hide_window = yes

	pre_triggers = {
		has_owner = yes
		is_occupied_flag = no
		has_ground_combat = no
	}

	trigger = {
		can_generate_trade_value = yes
		NOR = {
			is_planet_class = pc_cosmogenesis_world
			planet_stability >= @stabilitylevel2
			sapient_pop_amount < 1000
			has_orbital_bombardment = yes
			owner = {
				any_situation = { is_situation_type = situation_planetary_revolt }
			}
			has_planet_flag = 3_year_owner_change_flag
			has_planet_flag = recent_revolt_attempt
		}
		exists = controller
		controller = { is_same_empire = root.owner }
		OR = {
			owner = { is_gestalt = yes }
			any_owned_species = { species_has_happiness_with_owner = root.owner }
		}
		check_variable_arithmetic = { # Will the revolt actually tick up?
			which = value:potential_revolt_situation_monthly_progress_estimation
			value > 0
		}
	}

	immediate = {
		if = {
			limit = { # Extra safety because it's possible for two planets to fire this delayed event on the same day and it will check the trigger before either of them can fire (as of March 2022)
				NOT = {
					owner = {
						any_situation = { is_situation_type = situation_planetary_revolt }
					}
				}
			}
			set_timed_planet_flag = { flag = unrest_timer days = 3 } # To be sure
			owner = { # Generally, one would expect the strongest planet to be the center of the revolt
				# Use case here is if you conquer a whole bunch of enemy planets at once.
				ordered_owned_planet = {
					position = 0
					order_by = trigger:pop_amount
					limit = {
						has_planet_flag = unrest_timer
						NOR = {
							planet_stability >= @stabilitylevel2
							has_orbital_bombardment = yes
							has_ground_combat = yes
							is_occupied_flag = yes
							has_planet_flag = 3_year_owner_change_flag
							has_planet_flag = recent_revolt_attempt
						}
						exists = controller
						controller = { is_same_empire = root.owner }
						OR = {
							owner = { is_gestalt = yes }
							any_owned_species = { species_has_happiness_with_owner = root.owner }
						}
						check_variable_arithmetic = { # Will the revolt actually tick up?
							which = value:potential_revolt_situation_monthly_progress_estimation
							value > 0
						}
					}
					planet_event = { id = unrest.55 }
				}
			}
		}
	}
}

# Edit: added ccrebel_hm.1 & ccrebel_hm.2 (for hive and machine empire) + a bit code opt
situation_event = {
	id = unrest.100
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		NOR = {
			situation_progress <= 25
			has_situation_flag = 25_percent_event
		}
	}

	immediate = {
		set_situation_flag = 25_percent_event
		target = {
			set_timed_planet_flag = { flag = recent_unrest_event days = @unrest_event_cooldown }
			random_list = {
				1 = {
					planet_event = { id = unrest.115 }
					root = { set_situation_flag = spiritualist }
					modifier = {
						factor = 0
						count_owned_pop_amount = {
							count = 0
							limit = { pop_group_has_ethic = ethic_spiritualist }
						}
					}
					complex_trigger_modifier = {
						trigger = count_owned_pop_amount
						parameters = {
							limit = { pop_group_has_ethic = ethic_spiritualist }
						}
						mode = add
					}
					modifier = {
						factor = 0.5
						owner = { is_spiritualist = yes }
					}
				}
				1 = {
					planet_event = { id = unrest.120 }
					root = { set_situation_flag = authoritarian }
					modifier = {
						factor = 0
						count_owned_pop_amount = {
							count = 0
							limit = { pop_group_has_ethic = ethic_authoritarian }
						}
					}
					complex_trigger_modifier = {
						trigger = count_owned_pop_amount
						parameters = {
							limit = { pop_group_has_ethic = ethic_authoritarian }
						}
						mode = add
					}
					modifier = {
						factor = 0.5
						owner = { is_authoritarian = yes }
					}
					modifier = {
						factor = 0.5
						owner = { is_imperial_authority = yes }
					}
					modifier = {
						factor = 2.0
						owner = { is_democratic_authority = yes }
					}
				}
				1 = {
					planet_event = { id = unrest.125 }
					root = { set_situation_flag = xenophobe }
					complex_trigger_modifier = {
						trigger = count_owned_pop_amount
						parameters = {
							limit = { pop_group_has_ethic = ethic_xenophobe }
						}
						mode = add
					}
					modifier = {
						factor = 0
						OR = {
							count_owned_pop_amount = {
								count = 0
								limit = { pop_group_has_ethic = ethic_xenophobe }
							}
							owner = { has_comms_with_alien_empire = no }
						}
					}
					modifier = {
						factor = 0.25
						count_owned_species = {
							count = 0
							limit = {
								NOR = {
									is_same_species = prev.owner
									species_has_happiness_with_owner = prev.owner
								}
							}
						}
					}
					modifier = {
						factor = 0.5
						owner = { is_xenophobe = yes }
					}
					modifier = { factor = 0.5 is_majority_species = owner }
					modifier = {
						factor = 2.0
						NOT = { is_majority_species = owner }
					}
				}
				1 = {
					planet_event = { id = unrest.130 }
					root = { set_situation_flag = spiritualist }
					modifier = {
						factor = 0
						count_owned_pop_amount = {
							count = 0
							limit = { pop_group_has_ethic = ethic_materialist }
						}
					}
					complex_trigger_modifier = {
						trigger = count_owned_pop_amount
						parameters = {
							limit = { pop_group_has_ethic = ethic_materialist }
						}
						mode = add
					}
					modifier = {
						factor = 0.5
						owner = { is_materialist = yes }
					}
				}
				1 = {
					planet_event = { id = unrest.135 }
					root = { set_situation_flag = xenophile }
					modifier = {
						factor = 0
						OR = {
							owner = { has_comms_with_alien_empire = no }
							count_owned_pop_amount = {
								count = 0
								limit = { pop_group_has_ethic = ethic_xenophile }
							}
						}
					}
					modifier = {
						factor = 0.25
						count_owned_species = {
							count = 0
							limit = {
								NOR = {
									is_same_species = prev.owner
									species_has_happiness_with_owner = prev.owner
								}
							}
						}
					}
					complex_trigger_modifier = {
						trigger = count_owned_pop_amount
						parameters = {
							limit = { pop_group_has_ethic = ethic_xenophile }
						}
						mode = add
					}
					modifier = {
						factor = 0.5
						owner = { is_xenophile = yes }
					}
				}
				1 = {
					planet_event = { id = unrest.140 }
					root = { set_situation_flag = egalitarian }
					modifier = {
						factor = 0
						count_owned_pop_amount = {
							count = 0
							limit = { pop_group_has_ethic = ethic_egalitarian }
						}
					}
					complex_trigger_modifier = {
						trigger = count_owned_pop_amount
						parameters = {
							limit = { pop_group_has_ethic = ethic_egalitarian }
						}
						mode = add
					}
					modifier = {
						factor = 0.5
						owner = { is_egalitarian = yes }
					}
					modifier = {
						factor = 0.5
						owner = { is_democratic_authority = yes }
					}
					modifier = {
						factor = 2.0
						owner = { is_imperial_authority = yes }
					}
				}
				1 = {
					planet_event = { id = unrest.145 }
					root = { set_situation_flag = pacifist }
					modifier = {
						factor = 0
						count_owned_pop_amount = {
							count = 0
							limit = { pop_group_has_ethic = ethic_pacifist }
						}
					}
					complex_trigger_modifier = {
						trigger = count_owned_pop_amount
						parameters = {
							limit = { pop_group_has_ethic = ethic_pacifist }
						}
						mode = add
					}
					modifier = {
						factor = 0.5
						owner = { is_pacifist = yes }
					}
					modifier = {
						factor = 2.0
						owner = { is_at_war = yes }
					}
				}
				1 = {
					planet_event = { id = unrest.150 }
					root = { set_situation_flag = militarist }
					modifier = {
						factor = 0
						count_owned_pop_amount = {
							count = 0
							limit = { pop_group_has_ethic = ethic_militarist }
						}
					}
					complex_trigger_modifier = {
						trigger = count_owned_pop_amount
						parameters = {
							limit = { pop_group_has_ethic = ethic_militarist }
						}
						mode = add
					}
					modifier = {
						factor = 0.5
						owner = { is_militarist = yes }
					}
					modifier = {
						factor = 0.75
						owner = { is_at_war = yes }
					}
				}
				1 = {
					if = {
						limit = { owner = { is_hive_empire = yes } }
						root = { set_situation_flag = hive }
						planet_event = { id = ccrebel_hm.1 }
					}
					else_if = {
						limit = {
							owner = { is_machine_empire = yes }
						}
						root = { set_situation_flag = machine }
						planet_event = { id = ccrebel_hm.2 }
					}
					# Nothing else. We don't really need an event here for them.
					modifier = {
						factor = 0
						NAND = {
							owner = { is_gestalt = yes }
							any_owned_pop_group = {
								NOT = { pop_group_has_ethic = ethic_gestalt_consciousness }
							}
						}
					}
				}
			}
		}
	}
}

# # DEPRECATED: REMOVEME in v4.0 now handled by unrest.100
# # Reduced cooldowns to 1 year, also added some modifiers to the MTTH. (Vanilla removed in v3.6)
# # SLAVE REVOLT CHAIN #
# # Stirrings
# planet_event = {
# 	id = unrest.155
# 	title = unrest.155.name
# 	desc = unrest.155.desc
# 	picture = GFX_evt_alien_propaganda
# 	show_sound = event_planetary_riot
# 	location = root
# 	is_triggered_only = yes # MTTH disabled
# 	pre_triggers = { has_owner = yes is_occupied_flag = no has_ground_combat = no }
# 	# trigger = {
# 	# 	can_generate_trade_value = yes
# 	# 	NOR = {
# 	# 		planet_stability >= @stabilitylevel3
# 	# 		has_orbital_bombardment = yes
# 	# 		has_planet_flag = slave_stirring
# 	# 		has_planet_flag = recent_unrest_event
# 	# 		has_modifier = slave_hunger_strike
# 	# 		has_modifier = slave_riots
# 	# 		has_modifier = adding_unrest_slaves
# 	# 		has_modifier = revolt_suppressed
# 	# 	}
# 	# 	exists = controller
# 	# 	controller = { is_same_empire = root.owner }
# 	# 	any_enslaved_species = { is_sapient = yes species_has_happiness_with_owner = root.owner }
# 	# }
# 	# mean_time_to_happen = {
# 	# 	years = 40
# 	# 	modifier = { factor = 0.8 planet_stability < @stabilitylevel2 }
# 	# 	modifier = { factor = 0.8 planet_stability < @stabilitylevel1 }
# 	# 	modifier = { factor = 0.8 planet_stability < @stabilitylevel0 }
# 	# 	modifier = { factor = 0.8 has_planet_flag = ccrebel_perf_slaves_maj }
# 	# 	modifier = { factor = 1.33 any_owned_pop_group = { has_modifier = pop_recently_conquered } }
# 	# }
# 	# immediate = {
# 	# 	add_modifier = { modifier = adding_unrest_slaves years = 20 }
# 	# 	set_timed_planet_flag = { flag = recent_unrest_event months = 16 }
# 	# 	set_planet_flag = slave_revolt_chain_active
# 	# 	set_timed_planet_flag = { flag = slave_stirring years = 20 }
# 	# 	root.owner = { set_country_flag = slave_revolt_chain_active }
# 	# 	save_event_target_as = revolt_planet
# 	# 	planet_event = { id = unrest.170 days = 481 }
# 	# }
# 	option = { name = unrest.155.a }
# }
# # DEPRECATED: REMOVEME in v4.0
# # Chain Gatekeeper Event from # Stirrings id = unrest.155 (Vanilla removed in v3.6)
# planet_event = {
# 	id = unrest.170
# 	hide_window = yes
# 	is_triggered_only = yes
# 	pre_triggers = { has_owner = yes is_occupied_flag = no has_ground_combat = no }
# 	trigger = {
# 		can_generate_trade_value = yes
# 		exists = controller
# 		controller = { is_same_empire = root.owner }
# 		# owner = { has_country_flag = slave_revolt_chain_active }
# 		has_orbital_bombardment = no
# 		any_owned_species = { species_has_happiness_with_owner = root.owner }
# 	}
# 	# immediate = {
# 	# 	if = {
# 	# 		limit = {
# 	# 			planet_stability < @stabilitylevel2
# 	# 			any_enslaved_species = { is_sapient = yes species_has_happiness_with_owner = root.owner }
# 	# 			NOT = { has_planet_flag = recent_unrest_event }
# 	# 		}
# 	# 		# Fire Resistance
# 	# 		if = {
# 	# 			limit = {
# 	# 				has_planet_flag = slave_stirring
# 	# 				NOT = { has_planet_flag = slave_resistance }
# 	# 			}
# 	# 			planet_event = { id = unrest.158 }
# 	# 		}
# 	# 		# Fire Riots - Since 3.4 situation event
# 	# 		else_if = {
# 	# 			limit = {
# 	# 				planet_stability < @stabilitylevel1
# 	# 				has_planet_flag = slave_resistance
# 	# 				NOT = { has_modifier = slave_riots }
# 	# 			}
# 	# 			planet_event = { id = unrest.1571 }
# 	# 		}
# 	# 		# Fire Revolt
# 	# 		else_if = {
# 	# 			limit = {
# 	# 				planet_stability < @stabilitylevel1
# 	# 				is_variable_set = unrest_50
# 	# 				if = {
# 	# 					limit = { owner = { is_ai = yes } }
# 	# 					check_variable = { which = unrest_50 value > 48 }
# 	# 				}
# 	# 				else = {
# 	# 					check_variable = { which = unrest_50 value > 36 }
# 	# 				}
# 	# 				has_modifier = slave_riots
# 	# 				NOT = { has_planet_flag = slave_revolt }
# 	# 			}
# 	# 			planet_event = { id = unrest.160 }
# 	# 			clear_variable = unrest_50
# 	# 		}
# 	# 	}
# 	# 	planet_event = { id = unrest.170 days = 60 }
# 	# }
# }
# # DEPRECATED: REMOVEME in v4.0
# # Resistance gatekeeper event (Vanilla removed in v3.6) from unrest.170
# planet_event = {
# 	id = unrest.158
# 	hide_window = yes
# 	pre_triggers = { has_owner = yes is_occupied_flag = no has_ground_combat = no }
# 	trigger = {
# 		can_generate_trade_value = yes
# 		# has_planet_flag = slave_stirring
# 		NOR = {
# 			planet_stability >= @stabilitylevel2
# 			# has_planet_flag = slave_resistance
# 			has_planet_flag = recent_unrest_event
# 			has_orbital_bombardment = yes
# 			has_ground_combat = yes
# 		}
# 		exists = controller
# 		controller = { is_same_empire = root.owner }
# 		any_enslaved_species = { is_sapient = yes species_has_happiness_with_owner = root.owner }
# 	}
# 	is_triggered_only = yes
# 	# immediate = {
# 	# 	save_event_target_as = target
# 	# 	if = {
# 	# 		limit = { has_modifier = adding_unrest_slaves }
# 	# 		random_list = {
# 	# 			50 = { planet_event = { id = unrest.156 } }
# 	# 			50 = { planet_event = { id = unrest.1591 } }
# 	# 		}
# 	# 	}
# 	# 	else = {
# 	# 		planet_event = { id = unrest.1591 }
# 	# 	}
# 	# 	planet_event = { id = unrest.1571 days = 365 random = 10 }
# 	# }
# }
# Resistance: Sabotage (Vanilla)
# planet_event = {
# 	id = unrest.156
# 	title = unrest.156.name
# 	desc = unrest.156.desc
# 	picture = GFX_evt_night_raid # GFX_evt_burning_settlement
# 	show_sound = event_ship_explosion
# 	location = this
# 	situation = from
# 	is_triggered_only = yes
# 	immediate = {
# 		add_planet_devastation = 30
# 		set_timed_planet_flag = { flag = recent_unrest_event years = 1 }
# 		set_timed_planet_flag = { flag = slave_resistance years = 10 }
# 	}
# 	option = {
# 		name = unrest.156.a
# 	}
# 	option = {
# 		name = unrest.156.b
# 	}
# 	after = {
# 		tooltip = { add_planet_devastation = 30 }
# 	}
# }
# DEPRECATED: REMOVEME in v4.0
# Resistance: hunger strike (Vanilla)
# planet_event = {
# 	id = unrest.1591
# 	title = unrest.159.name
# 	desc = unrest.159.desc
# 	picture = GFX_evt_burning_settlement
# 	show_sound = event_planetary_riot
# 	location = root
# 	is_triggered_only = yes
# 	immediate = {
# 		save_event_target_as = target # Compat hack revolt_planet
# 		set_timed_planet_flag = { flag = recent_unrest_event years = 1 }
# 		add_modifier = { modifier = slave_hunger_strike years = 5 }
# 		set_timed_planet_flag = { flag = slave_resistance years = 10 }
# 	}
# 	option = { name = unrest.159.a }
# 	option = { name = unrest.159.b }
# 	after = {
# 		tooltip = {
# 			add_modifier = { modifier = slave_hunger_strike years = 5 }
# 		}
# 	}
# }
# DEPRECATED: REMOVEME in v4.0
# Riots (Vanilla)
# planet_event = {
# 	id = unrest.1571
# 	title = unrest.157.name
# 	desc = unrest.157.desc
# 	picture = GFX_evt_burning_settlement
# 	show_sound = event_planetary_riot
# 	location = root
# 	pre_triggers = { has_owner = yes is_occupied_flag = no }
# 	trigger = {
# 		can_generate_trade_value = yes
# 		exists = controller
# 		controller = { is_same_empire = root.owner }
# 		planet_stability < @stabilitylevel1
# 		has_planet_flag = slave_resistance
# 		any_enslaved_species = { is_sapient = yes species_has_happiness_with_owner = root.owner }
# 		NOR = { has_planet_flag = recent_unrest_event has_modifier = slave_riots }
# 	}
# 	is_triggered_only = yes
# 	immediate = {
# 		save_event_target_as = target # Compat hack revolt_planet
# 		set_timed_planet_flag = { flag = recent_unrest_event years = 1 }
# 		# set_timed_planet_flag = { flag = slave_riots years = 10 }
# 		add_modifier = { modifier = slave_riots years = 10 }
# 	}
# 	option = { name = unrest.157.a }
# 	option = { name = unrest.157.b }
# 	after = {
# 		tooltip = {
# 			add_modifier = { modifier = slave_riots years = 10 }
# 		}
# 	}
# }
# Added new slave civics
# Revolt replaced by unrest.4200
# planet_event = {
# 	id = unrest.160
# 	title = unrest.160.name
# 	desc = unrest.160.desc
# 	picture = GFX_evt_ground_combat
# 	show_sound = event_planetary_riot
# 	location = root
# 	pre_triggers = { has_owner = yes is_occupied_flag = no }
# 	trigger = {
# 		can_generate_trade_value = yes
# 		exists = controller
# 		controller = { is_same_empire = root.owner }
# 		planet_stability < @stabilitylevel1
# 		has_modifier = slave_riots
# 		any_enslaved_species = { is_sapient = yes species_has_happiness_with_owner = root.owner }
# 		NOR = { has_planet_flag = slave_revolt has_planet_flag = recent_unrest_event }
# 	}
# 	is_triggered_only = yes
# 	immediate = {
#		 ordered_owned_pop_group = { # This has probably worse performance
#		 	limit = { is_sapient_slave = yes }
#		 	position = 0
#		 	order_by = trigger:species_planet_slave_percentage
#		 	species = { save_event_target_as = rebellion_species }
#	 }
# 		create_rebels = {
# 			ethos = { ethic = "ethic_fanatic_egalitarian" ethic = "ethic_militarist" }
# 			authority = auth_democratic
# 			civics = { civic = civic_free_republic civic = civic_broken_shackles }
# 			name = random
# 			species = event_target:rebellion_species
# 			flag = random
# 			name_list = "CCSLAVE1"
# 			effect = {
# 				random_list = {
# 					1 = { change_country_flag = { icon = { category = "slave" file = "ccslave1.dds" } background = { category = "backgrounds" file = "circle.dds" } colors = { "blue" "grey" "null" "null" } } }
# 					1 = { change_country_flag = { icon = { category = "slave" file = "ccslave2.dds" } background = { category = "backgrounds" file = "circle.dds" } colors = { "dark_purple" "orange" "null" "null" } } }
# 					1 = { change_country_flag = { icon = { category = "slave" file = "ccslave3.dds" } background = { category = "backgrounds" file = "sinus.dds" } colors = { "brown" "turquoise" "null" "null" } } }
# 					1 = { change_country_flag = { icon = { category = "slave" file = "ccslave4.dds" } background = { category = "backgrounds" file = "sinus.dds" } colors = { "green" "orange" "null" "null" } } }
# 					1 = { change_country_flag = { icon = { category = "slave" file = "ccslave5.dds" } background = { category = "backgrounds" file = "vertical.dds" } colors = { "burgundy" "teal" "null" "null" } } }
# 					1 = { change_country_flag = { icon = { category = "slave" file = "ccslave6.dds" } background = { category = "backgrounds" file = "vertical.dds" } colors = { "blue" "red_orange" "null" "null" } } }
# 					3 = { randomize_flag_symbol = "slave" }
# 				}
# 				set_country_flag = slave_rebels
# 				save_event_target_as = rebelling_slaves
# 				establish_communications_no_message = root.owner
# 				set_relation_flag = { flag = rebelling_slaves_former_owner who = root.owner }
# 				root = {
# 					owner = {
# 						every_relation = {
# 							limit = { has_communications = prev }
# 							establish_communications_no_message = prevprevprev
# 						}
# 					}
# 					every_planet_army = {
# 						limit = { army_type = slave_army }
# 						set_owner = event_target:rebelling_slaves
# 					}
# 					export_trigger_value_to_variable = {
# 						trigger = count_owned_pop_amount
# 						variable = rebel_armies_var
# 						parameters = {
# 							limit = { is_sapient_slave = yes }
# 						}
# 					}
# 					multiply_variable = { which = rebel_armies_var value = 2 }
# 					while = { count = rebel_armies_var
# 						create_army = {
# 							name = "NAME_Freedom_Fighters"
# 							owner = event_target:rebelling_slaves
# 							species = event_target:rebellion_species
# 							type = "rebel_slave_defense_army"
# 						}
# 					}
# 				}
# 				create_leader = {
# 					class = random_ruler
# 					species = owner_species
# 					name = random
# 					skill = 2
# 				}
# 				assign_leader = last_created_leader
# 				ruler = { add_trait = random_common }
# 			}
# 		}
# 		set_planet_flag = slave_revolt
# 		set_timed_planet_flag = { flag = recent_unrest_event years = 2 }
# 	}
# 	option = { name = unrest.160.a custom_tooltip = unrest.160.a.tooltip }
# 	after = {
# 		hidden_effect = { clear_variable = rebel_armies_var }
# 	}
# }
# Revolt Suppressed (Vanilla) on_planet_defenders_win
# country_event = {
# 	id = unrest.161
# 	title = unrest.161.name
# 	desc = unrest.161.desc
# 	picture = GFX_evt_alien_propaganda
# 	show_sound = event_celebration
# 	location = event_target:revolt_planet
# 	trigger = {
# 		merg_is_default_empire = yes
# 		fromfrom = {
# 			has_planet_flag = slave_revolt
# 			controller = { is_same_empire = root }
# 		}
# 	}
# 	is_triggered_only = yes
# 	immediate = {
# 		remove_country_flag = slave_revolt_chain_active
# 		fromfrom = {
# 			add_modifier = { modifier = revolt_suppressed years = 10 }
# 			save_event_target_as = revolt_planet
# 			remove_planet_flag = slave_revolt_chain_active
# 			remove_planet_flag = slave_riots
# 			remove_planet_flag = slave_resistance
# 			remove_planet_flag = slave_stirring
# 			remove_planet_flag = slave_revolt
# 			if = {
# 				limit = { has_modifier = slave_hunger_strike }
# 				remove_modifier = slave_hunger_strike
# 			}
# 			if = {
# 				limit = { has_modifier = adding_unrest_slaves }
# 				remove_modifier = adding_unrest_slaves
# 			}
# 			if = {
# 				limit = { has_modifier = slave_riots }
# 				remove_modifier = slave_riots
# 			}
# 		}
# 	}
# 	option = {
# 		name = unrest.161.a
# 		tooltip = {
# 			add_modifier = { modifier = revolt_suppressed years = 10 }
# 		}
# 		custom_tooltip = unrest.161.a.tooltip
# 	}
# }
# (on_planet_defenders_lose) Triggers country_event for the defender upon defeat (removed in v3.6)
# This = country, planet owner
# From = country, attack leader
# fromfrom = planet
# Revolt Lost # Halve the distance + prefer free republics
country_event = {
	id = unrest.167
	title = unrest.167.name
	desc = unrest.167.desc
	picture = GFX_evt_burning_settlement
	show_sound = event_air_raid_siren
	location = event_target:revolt_planet
	is_triggered_only = yes

	trigger = {
		from = { is_country_type = rebel }
		fromfrom = { has_planet_flag = slave_revolt }
	}

	immediate = {
		fromfrom = {
			save_event_target_as = revolt_planet
			# remove_planet_flag = slave_revolt_chain_active # DEPRECATED: REMOVEME in v4.0
			# remove_planet_flag = slave_riots
			# remove_planet_flag = slave_resistance # DEPRECATED: REMOVEME in v4.0
			# remove_planet_flag = slave_stirring # DEPRECATED: REMOVEME in v4.0
			remove_planet_flag = slave_revolt
			if = {
				limit = { has_modifier = slave_hunger_strike }
				remove_modifier = slave_hunger_strike
			}
			if = {
				limit = { has_modifier = adding_unrest_slaves }
				remove_modifier = adding_unrest_slaves
			}
			if = {
				limit = { has_modifier = slave_riots }
				remove_modifier = slave_riots
			}
			if = {
				limit = { exists = leader }
				kill_leader = { class = official }
			}
			if = {
				limit = { has_modifier = free_at_last }
				remove_modifier = free_at_last
			}
			if = {
				limit = { has_modifier = insurgents_free }
				remove_modifier = insurgents_free
			}
			if = {
				limit = { has_modifier = slaves_defected }
				remove_modifier = slaves_defected
			}
		}
		from = { save_event_target_as = rebel_country }
		# remove_country_flag = slave_revolt_chain_active # DEPRECATED: REMOVEME in v4.0
		save_event_target_as = old_owner
		fromfrom.solar_system = {
			if = {
				limit = { exists = starbase }
				starbase = { set_owner = event_target:rebel_country }
			}
			add_claims = {
				who = event_target:old_owner
				num_of_claims = 1
				show_notification = no
			}
		}
		if = {
			# First choice is a rebellion
			limit = {
				any_playable_country = {
					is_same_species = from
					has_civic = civic_free_republic
					has_civic = civic_broken_shackles
					NOR = {
						has_country_flag = ccrebel_has_existed_5_years
						is_same_empire = root
						is_same_empire = from
						has_country_flag = cc_rebels_merging
						would_join_war = {
							attacker = from
							defender = root
							side = root
						}
					}
				}
			}
			random_playable_country = {
				limit = {
					is_same_species = from
					has_civic = civic_free_republic
					has_civic = civic_broken_shackles
					NOR = {
						has_country_flag = ccrebel_has_existed_5_years
						is_same_empire = root
						is_same_empire = from
						has_country_flag = cc_rebels_merging
						would_join_war = {
							attacker = from
							defender = root
							side = root
						}
					}
				}
				save_event_target_as = ccrebel_land_of_liberty
			}
		}
		else_if = {
			limit = {
				any_playable_country = {
					has_policy_flag = slavery_not_allowed
					has_civic = civic_free_republic
					has_civic = civic_broken_shackles
					has_communications = from
					any_owned_planet = {
						distance = {
							source = fromfrom
							max_distance <= 150
							min_distance >= 0
						}
					}
					NOR = {
						is_same_empire = root
						is_same_empire = from
						has_country_flag = cc_rebels_merging
						would_join_war = {
							attacker = from
							defender = root
							side = root
						}
					}
				}
			}
			random_playable_country = {
				limit = {
					has_policy_flag = slavery_not_allowed
					has_civic = civic_free_republic
					has_civic = civic_broken_shackles
					has_communications = from
					any_owned_planet = {
						distance = {
							source = fromfrom
							max_distance <= 150
							min_distance >= 0
						}
					}
					NOR = {
						is_same_empire = root
						is_same_empire = from
						has_country_flag = cc_rebels_merging
						would_join_war = {
							attacker = from
							defender = root
							side = root
						}
					}
				}
				save_event_target_as = ccrebel_land_of_liberty
			}
		}
		else_if = {
			# Second choice is same species but not slaveholders
			limit = {
				any_playable_country = {
					NOR = {
						is_same_empire = root
						is_same_empire = from
						has_country_flag = cc_rebels_merging
						would_join_war = {
							attacker = from
							defender = root
							side = root
						}
					}
					any_owned_planet = {
						distance = {
							# Changed max distance from 300 as that is quite a long way and I wanted some slave republics to actually exist.
							source = fromfrom
							max_distance <= 150
							min_distance >= 0
						}
					}
					is_subject = no
					has_policy_flag = slavery_not_allowed
					is_same_species = from
				}
			}
			random_playable_country = {
				limit = {
					has_policy_flag = slavery_not_allowed 						# Changed max distance from 300 as that is quite a long way and I wanted some slave republics to actually exist.
					NOR = {
						is_same_empire = root
						is_same_empire = from
						has_country_flag = cc_rebels_merging
						would_join_war = {
							attacker = from
							defender = root
							side = root
						}
					}
					any_owned_planet = {
						distance = {
							source = fromfrom
							max_distance <= 150
							min_distance >= 0
						}
					}
					is_subject = no
					is_same_species = from
				}
				save_event_target_as = slave_fatherland1
				set_timed_country_flag = { flag = cc_slave_fatherland7 days = 10 }
				save_event_target_as = ccrebel_land_of_liberty
			}
		}
		else_if = {
			# Third choice: random egalitarians
			limit = {
				any_playable_country = {
					has_policy_flag = slavery_not_allowed
					is_egalitarian = yes
					has_communications = root
					any_owned_planet = {
						# Changed max distance from 300 as that is quite a long way and I wanted some slave republics to actually exist.
						distance = {
							source = fromfrom
							max_distance <= 150
							min_distance >= 0
						}
					}
					NOR = {
						is_same_empire = root
						is_same_empire = from
						has_country_flag = cc_rebels_merging
						would_join_war = {
							attacker = from
							defender = root
							side = root
						}
					}
					has_ai_personality_behaviour = multispecies
				}
			}
			random_playable_country = {
				limit = {
					has_policy_flag = slavery_not_allowed
					is_egalitarian = yes
					has_communications = root
					any_owned_planet = {
						distance = {
							source = fromfrom
							max_distance <= 150
							min_distance >= 0
						}
					}
					NOR = {
						is_same_empire = root
						is_same_empire = from
						has_country_flag = cc_rebels_merging
						would_join_war = {
							attacker = from
							defender = root
							side = root
						}
					}
					has_ai_personality_behaviour = multispecies
				}
				save_event_target_as = ccrebel_land_of_liberty
			}
		}
		if = {
			limit = { exists = event_target:ccrebel_land_of_liberty }
			if = {
				limit = {
					event_target:ccrebel_land_of_liberty = {
						OR = {
							NOT = { has_country_flag = ccrebel_has_existed_5_years }
							is_at_war_with = root
							has_federation = yes # This is sadly necessary
						}
					}
				}
				event_target:ccrebel_land_of_liberty = {
					country_event = { id = unrest.168 days = 5 }					# Request merge
				}
				from = {
					set_timed_country_flag = { flag = ccrebel_dont_declare_war days = 5 }
					set_country_flag = cc_rebels_merging
				}
			}
			else = {
				save_event_target_as = rebelled_against
				event_target:ccrebel_land_of_liberty = { # I wonder whether this works
					country_event = { id = ccrebel_wg_script.10 days = 5 scopes = { fromfrom = fromfrom from = from } } # Request aid in war
				}
			}
		}
	}
	option = {
		name = unrest.167.a
	}
	option = {
		name = unrest.167.b
	}
	after = {
		fromfrom = {
			if = {
				limit = {
					NOT = { has_modifier = free_at_last }
				}
				add_modifier = {
					modifier = free_at_last
					clear_on_owner_change = yes
					years = 20
				}
			}
		}
	}
}

# Defect request #
country_event = {
	id = unrest.168
	desc = {
		trigger = { has_country_flag = cc_slave_fatherland7 }
		text = rebellionscript.132.desc
	}
	desc = {
		trigger = {
			NOT = { has_country_flag = cc_slave_fatherland7 }
		}
		text = unrest.168.desc
	}

	location = event_target:revolt_planet
	title = TRANSMISSION
	diplomatic = yes
	picture_event_data = {
		portrait = event_target:rebel_country
		planet_background = event_target:rebel_country.capital_scope
		city_level = event_target:rebel_country.capital_scope
		room = event_target:rebel_country.ruler
	}
	trigger = {
		is_scope_valid = yes
		exists = event_target:old_owner
		exists = event_target:rebel_country
		NOT = { is_same_empire = event_target:rebel_country }
	}

	immediate = {
		save_event_target_as = new_owner
	}

	is_triggered_only = yes
	# YES!
	option = {
		name = unrest.168.a
		custom_tooltip = unrest.168.a.tooltip
		ai_chance = { factor = 100 }
		event_target:revolt_planet = {
			set_owner = root
			solar_system = {
				if = {
					limit = { exists = starbase }
					starbase = { set_owner = root }
				}
			}
			add_modifier = { modifier = slaves_defected years = 20 }
		}
		hidden_effect = {
			event_target:rebel_country = {
				every_owned_starbase = { set_owner = root }
				every_owned_planet = {
					set_timed_planet_flag = { flag = ccrebel_rebellion_transfer days = 5 }
					set_owner = root
					hidden_effect = {
						if = {
							limit = { has_modifier = free_at_last }
							remove_modifier = free_at_last
						}
						if = {
							limit = { has_modifier = insurgents_free }
							remove_modifier = insurgents_free
						}
						if = {
							limit = { has_modifier = slaves_defected }
							remove_modifier = slaves_defected
						}
						add_modifier = { modifier = slaves_defected years = 20 }
					}
				}
			}
			if = {
				limit = { has_country_flag = cc_rebellion }
				set_timed_country_flag = { flag = cc_rebellion years = 1 }
			}
			if = {
				limit = { exists = event_target:old_owner }
				event_target:old_owner = {
					country_event = { id = unrest.169 }
				}
			}
			event_target:rebel_country = { set_country_flag = silence_destroy_event destroy_country = yes }
		}
	}

	# NO!
	option = {
		name = unrest.168.b
		hidden_effect = {
			if = {
				limit = {
					any_relation = {
						is_country_type_with_subjects = yes
						has_relation_flag = { who = event_target:rebel_country flag = ccrebel_declare_war_on }
						NOT = { is_at_war_with = event_target:rebel_country }
					}
				}
				random_relation = {
					limit = {
						is_country_type_with_subjects = yes
						has_relation_flag = { who = event_target:rebel_country flag = ccrebel_declare_war_on }
						NOT = { is_at_war_with = event_target:rebel_country }
					}
					save_event_target_as = ccrebel_declared_war_on
					event_target:rebel_country = {
						declare_war = { target = prev attacker_war_goal = wg_ccrebel_independence }
					}
				}
			}
		}
		ai_chance = { factor = 0 }
	}
}

# Slaves Defect Diplomatic Message # (Vanilla)
country_event = {
	id = unrest.169
	desc = unrest.169.desc
	location = event_target:revolt_planet
	title = TRANSMISSION
	diplomatic = yes
	picture_event_data = {
		portrait = from
		planet_background = from.capital_scope
		# graphical_culture = event_target:book_writer
		city_level = from.capital_scope
		room = from.ruler
	}

	is_triggered_only = yes
	option = {
		name = unrest.169.a
		add_opinion_modifier = { modifier = opinion_took_in_rebels who = from }
	}
	option = {
		name = unrest.169.b
		add_opinion_modifier = { modifier = opinion_took_in_rebels who = from }
	}
	option = {
		name = unrest.169.c
		add_opinion_modifier = { modifier = opinion_took_in_rebels who = from }
	}
}

# End chain if no more slaves # on_monthly_pulse
# event = {
# 	id = unrest.162
# 	hide_window = yes
# 	is_triggered_only = yes
# 	trigger = {
# 		any_playable_country = {
# 			has_country_flag = slave_revolt_chain_active
# 			any_owned_planet = {
# 				has_planet_flag = slave_revolt_chain_active
# 				controller = { is_same_empire = owner }
# 			}
# 		}
# 	}
# 	immediate = {
# 		every_playable_country = {
# 			limit = {
# 				has_country_flag = slave_revolt_chain_active
# 				any_owned_planet = { has_planet_flag = slave_revolt_chain_active }
# 			}
# 			every_owned_planet = {
# 				limit = {
# 					has_planet_flag = slave_revolt_chain_active
# 					count_owned_pop_amount = {
# 						limit = { is_sapient_slave = yes }
# 						count = 0
# 					}
# 				}
# 				planet_event = { id = unrest.163 }
# 			}
# 		}
# 	}
# }
# Slave Labor Discontinued
# planet_event = {
# 	id = unrest.163
# 	title = unrest.163.name
# 	desc = unrest.163.desc
# 	picture = GFX_evt_colony_settlement
# 	show_sound = event_administrative_work
# 	location = root
# 	is_triggered_only = yes
# 	immediate = {
# 		save_event_target_as = revolt_planet
# 		remove_planet_flag = slave_revolt_chain_active
# 		remove_planet_flag = slave_riots
# 		remove_planet_flag = slave_resistance
# 		remove_planet_flag = slave_stirring
# 		remove_planet_flag = slave_revolt
# 		if = {
# 			limit = { has_modifier = slave_hunger_strike }
# 			remove_modifier = slave_hunger_strike
# 		}
# 		if = {
# 			limit = { has_modifier = adding_unrest_slaves }
# 			remove_modifier = adding_unrest_slaves
# 		}
# 		if = {
# 			limit = { has_modifier = slave_riots }
# 			remove_modifier = slave_riots
# 		}
# 		root.owner = { remove_country_flag = slave_revolt_chain_active }
# 	}
# 	option = { name = EXCELLENT }
# }
# Planet Pacified # on_monthly_pulse
# event = {
# 	id = unrest.164
# 	hide_window = yes
# 	is_triggered_only = yes
# 	trigger = {
# 		any_playable_country = {
# 			has_country_flag = slave_revolt_chain_active
# 			any_owned_planet = {
# 				has_planet_flag = slave_revolt_chain_active
# 				planet_stability > @stabilitylevel3
# 				NOR = { has_modifier = slave_hunger_strike has_modifier = adding_unrest_slaves has_modifier = slave_riots }
# 			}
# 		}
# 	}
# 	immediate = {
# 		every_playable_country = {
# 			limit = {
# 				has_country_flag = slave_revolt_chain_active
# 				any_owned_planet = {
# 					has_planet_flag = slave_revolt_chain_active
# 					planet_stability > @stabilitylevel3
# 					NOR = { has_modifier = slave_hunger_strike has_modifier = adding_unrest_slaves has_modifier = slave_riots }
# 				}
# 			}
# 			every_owned_planet = {
# 				limit = {
# 					has_planet_flag = slave_revolt_chain_active
# 					planet_stability > @stabilitylevel3
# 					NOR = { has_modifier = slave_hunger_strike has_modifier = adding_unrest_slaves has_modifier = slave_riots }
# 				}
# 				planet_event = { id = unrest.165 }
# 			}
# 		}
# 	}
# }
# planet_event = {
# 	id = unrest.165
# 	title = unrest.165.name
# 	desc = unrest.165.desc
# 	picture = GFX_evt_colony_settlement
# 	show_sound = event_administrative_work
# 	location = root
# 	is_triggered_only = yes
# 	immediate = {
# 		save_event_target_as = revolt_planet
# 		remove_planet_flag = slave_revolt_chain_active
# 		remove_planet_flag = slave_riots
# 		remove_planet_flag = slave_resistance
# 		remove_planet_flag = slave_stirring
# 		remove_planet_flag = slave_revolt
# 		root.owner = { remove_country_flag = slave_revolt_chain_active }
# 	}
# 	option = { name = OK }
# }
# on_monthly_pulse # Removed in v3.6
# Revolt Gatekeeper: unrest needs to be >50 for 3 years before triggering revolt
# event = {
# 	id = unrest.166
# 	is_triggered_only = yes
# 	hide_window = yes
# 	trigger = {
# 		any_playable_country = {
# 			any_owned_planet = {
# 				has_modifier = slave_riots # has_planet_flag = slave_riots
# 				OR = { is_variable_set = unrest_50 planet_stability < @stabilitylevel2 }
# 			}
# 		}
# 	}
# 	immediate = {
# 		random_playable_country = {
# 			limit = {
# 				any_owned_planet = {
# 					is_colony = yes
# 					has_modifier = slave_riots # has_planet_flag = slave_riots
# 					OR = { is_variable_set = unrest_50 planet_stability < @stabilitylevel2 }
# 				}
# 			}
# 			random_owned_planet = {
# 				limit = {
# 					is_colony = yes
# 					has_modifier = slave_riots # has_planet_flag = slave_riots
# 					OR = { is_variable_set = unrest_50 planet_stability < @stabilitylevel2 }
# 				}
# 				if = {
# 					limit = { is_variable_set = unrest_50 }
# 					if = {
# 						limit = { planet_stability < @stabilitylevel2 }
# 						change_variable = { which = unrest_50 value = 1 }
# 					}
# 					else = { clear_variable = unrest_50 }
# 				}
# 				else_if = {
# 					limit = { planet_stability < @stabilitylevel2 }
# 					set_variable = { which = unrest_50 value = 1 }
# 				}
# 			}
# 		}
# 	}
# }
######## SECESSION/NATIONALIST REVOLT HAPPENS ##########

situation_event = {
	id = unrest.4200
	title = unrest.4200.name
	desc = {
		trigger = {
			owner = { is_regular_empire = yes }
			NOR = {
				exists = event_target:new_owner_empire
				has_situation_flag = slave_revolt
			}
		}
		text = unrest.4200.desc.regular_no_join
	}
	desc = {
		trigger = {
			owner = { is_regular_empire = yes }
			exists = event_target:new_owner_empire
			NOT = { has_situation_flag = slave_revolt }
		}
		text = unrest.4200.desc.regular_join
	}
	desc = {
		trigger = {
			owner = { is_regular_empire = yes }
			NOT = { exists = event_target:new_owner_empire }
			has_situation_flag = slave_revolt
		}
		text = unrest.4200.desc.slave.no_join
	}
	desc = {
		trigger = {
			owner = { is_regular_empire = yes }
			exists = event_target:new_owner_empire
			has_situation_flag = slave_revolt
		}
		text = unrest.4200.desc.slave.join
	}
	desc = {
		trigger = {
			owner = { is_hive_empire = yes }
			NOT = { exists = event_target:new_owner_empire }
			event_target:rebel_empire = { is_hive_empire = yes }
		}
		text = unrest.4200.desc.hive_no_join
	}
	desc = {
		trigger = {
			owner = { is_hive_empire = yes }
			NOT = { exists = event_target:new_owner_empire }
			event_target:rebel_empire = { is_hive_empire = no }
		}
		text = unrest.4200.desc.hive_no_join_regular
	}
	desc = {
		trigger = {
			owner = { is_hive_empire = yes }
			exists = event_target:new_owner_empire
		}
		text = unrest.4200.desc.hive_join
	}
	desc = {
		trigger = {
			owner = { is_machine_empire = yes }
			NOT = { exists = event_target:new_owner_empire }
			event_target:rebel_empire = { is_machine_empire = yes }
		}
		text = unrest.4200.desc.machine_no_join
	}
	desc = {
		trigger = {
			owner = { is_machine_empire = yes }
			NOT = { exists = event_target:new_owner_empire }
			event_target:rebel_empire = { is_machine_empire = no }
		}
		text = unrest.4200.desc.machine_no_join_regular
	}
	desc = {
		trigger = {
			owner = { is_machine_empire = yes }
			exists = event_target:new_owner_empire
		}
		text = unrest.4200.desc.machine_join
	}

	picture = GFX_evt_surrender
	show_sound = event_ground_battle
	location = root.target
	situation = this
	force_open = yes
	is_triggered_only = yes

	immediate = {
		save_event_target_as = revolt_situation
		owner = {
			save_event_target_as = old_owner
			if = {
				limit = { is_ai = yes }
				log = "AI [This.GetName] suffered a rebellion on [Root.Target.GetName] in [GetYear]"
			}
			else = {
				log = "Player [This.GetName] suffered a rebellion on [Root.Target.GetName] in [GetYear]"
			}
		}
		target = {
			random_owned_species = {
				limit = { has_species_flag = rebellion_species@root }
				save_event_target_as = rebellion_species
			}
			set_planet_flag = revolt_in_progress # Removed in v3.6
			# if = { limit = { is_variable_set = unrest_50 } clear_variable = unrest_50 } # Removed in v3.6
			save_event_target_as = rebel_planet
		}
		if = {
			limit = {
				NOT = { exists = event_target:rebellion_species }
			}
			deduce_planetary_separatism_species = yes
		}
		random_playable_country = {
			limit = {
				has_country_flag = revolt_joiner_empire_@root
				# Check eligibility again in case there are pacts in the meantime or something went wrong
				basic_eligibility_for_separatism_joining_trigger = yes
			}
			save_event_target_as = new_owner_empire
		}
		target = {
			# Has original owner?
			if = {
				limit = {
					original_owner = no
					any_country = {
						is_country_type_with_subjects = yes
						NOR = {
							is_same_empire = root.owner
							is_subject = yes
							is_gestalt = yes
						}
						prev = { is_original_owner = prev }
						is_same_species = event_target:rebellion_species
					}
				}
				random_country = {
					limit = {
						is_country_type_with_subjects = yes
						NOR = {
							is_same_empire = root.owner
							is_subject = yes
							is_gestalt = yes
						}
						prev = { is_original_owner = prev }
						is_same_species = event_target:rebellion_species
					}
					save_event_target_as = fatherland
				}
			}
			export_trigger_value_to_variable = { trigger = sapient_pop_amount variable = rebel_armies_var }
			multiply_variable = { which = rebel_armies_var value = 0.002 } # Was 0.33
			if = { # No legitimate owner # Slave rebels
				limit = {
					root = { has_situation_flag = slave_revolt }
					pop_amount_percentage = {
						percentage > 0.32
						limit = { is_sapient_slave = yes }
					}
				}
				create_rebels = {
					name = random
					ethos = { ethic = "ethic_fanatic_egalitarian" ethic = "ethic_militarist" }
					authority = auth_democratic
					civics = { civic = civic_free_republic civic = civic_broken_shackles }
					species = event_target:rebellion_species
					flag = random
					name_list = "CCSLAVE1"
					effect = {
						random_list = {
							1 = {
								change_country_flag = {
									icon = { category = "slave" file = "cc_slave1.dds" }
									background = { category = "backgrounds" file = "circle.dds" }
									colors = {
										"blue"
										"grey"
										"null"
										"null"
									}
								}
							}
							1 = {
								change_country_flag = {
									icon = { category = "slave" file = "cc_slave2.dds" }
									background = { category = "backgrounds" file = "circle.dds" }
									colors = {
										"dark_purple"
										"orange"
										"null"
										"null"
									}
								}
							}
							1 = {
								change_country_flag = {
									icon = { category = "slave" file = "cc_slave3.dds" }
									background = { category = "backgrounds" file = "sinus.dds" }
									colors = {
										"brown"
										"turquoise"
										"null"
										"null"
									}
								}
							}
							1 = {
								change_country_flag = {
									icon = { category = "slave" file = "cc_slave4.dds" }
									background = { category = "backgrounds" file = "sinus.dds" }
									colors = {
										"green"
										"orange"
										"null"
										"null"
									}
								}
							}
							1 = {
								change_country_flag = {
									icon = { category = "slave" file = "cc_slave5.dds" }
									background = { category = "backgrounds" file = "vertical.dds" }
									colors = {
										"burgundy"
										"teal"
										"null"
										"null"
									}
								}
							}
							1 = {
								change_country_flag = {
									icon = { category = "slave" file = "cc_slave6.dds" }
									background = { category = "backgrounds" file = "vertical.dds" }
									colors = {
										"blue"
										"red_orange"
										"null"
										"null"
									}
								}
							}
							3 = { randomize_flag_symbol = "slave" }
						}
						set_country_flag = slave_rebels
						save_event_target_as = secessionist_rebels
						set_relation_flag = { flag = rebelling_slaves_former_owner who = root.owner }
					}
				}
				multiply_variable = { which = rebel_armies_var value = 2 }
				while = {
					count = rebel_armies_var
					create_army = {
						name = "NAME_Freedom_Fighters"
						owner = event_target:secessionist_rebels
						species = event_target:secessionist_rebels
						type = "rebel_slave_defense_army"
					}
				}
				set_planet_flag = slave_revolt
			}
			else_if = {
				limit = { exists = event_target:fatherland }
				create_rebels = {
					name = random
					ethos = event_target:fatherland
					authority = random
					civics = random # event_target:fatherland
					species = event_target:fatherland
					flag = random
					effect = {
						set_country_flag = standard_unrest_rebels
						save_event_target_as = nationalist_rebels
						establish_communications_no_message = event_target:fatherland
					}
				}
				while = {
					count = rebel_armies_var
					create_army = {
						name = NAME_ccrebel_Nationalist_Revolutionaries
						owner = event_target:nationalist_rebels
						species = event_target:fatherland
						type = "assault_army"
					}
				}
				set_planet_flag = nationalist_revolt
			}
			else = { # non-slaves
				create_rebels = {
					name = random
					ethos = random
					authority = random
					civics = random
					species = event_target:rebellion_species
					flag = random
					effect = {
						set_country_flag = standard_unrest_rebels
						save_event_target_as = secessionist_rebels
					}
				}
				while = {
					count = rebel_armies_var
					create_army = {
						name = NAME_ccrebel_Revolutionary_Brigade
						owner = event_target:secessionist_rebels
						species = event_target:secessionist_rebels
						type = "assault_army"
					}
				}
				set_planet_flag = secessionist_revolt
			}
		}
		last_created_country = {
			set_country_type = default # We don't need the rebel country type with this version, but create_rebels effect has useful functionalities
			save_event_target_as = rebel_empire
			fire_on_action = { on_action = on_released_as_vassal scopes = { from = event_target:old_owner } } # set_origin_effect = yes
			if = {
				limit = {
					NOR = {
						is_gestalt = yes
						root = { has_situation_flag = slave_revolt }
					}
				}
				root = {
					switch = {
						trigger = has_situation_flag
						pacifist = {
							prev = { shift_ethic = ethic_fanatic_pacifist }
						}
						militarist = {
							prev = { shift_ethic = ethic_fanatic_militarist }
						}
						authoritarian = {
							prev = { shift_ethic = ethic_fanatic_authoritarian }
						}
						egalitarian = {
							prev = { shift_ethic = ethic_fanatic_egalitarian }
						}
						xenophile = {
							prev = { shift_ethic = ethic_fanatic_xenophile }
						}
						xenophobe = {
							prev = { shift_ethic = ethic_fanatic_xenophobe }
						}
						spiritualist = {
							prev = { shift_ethic = ethic_fanatic_spiritualist }
						}
						materialist = {
							prev = { shift_ethic = ethic_fanatic_materialist }
						}
					}
				}
				set_timed_country_flag = { flag = cc_rebel_ethic_sorted days = 14 }
				change_government = {
					authority = random
					civics = random
					remove_invalid_civics = yes
				}
				# set_name = random # Because sometimes native didn't work?
			}
			create_leader = {
				class = commander
				species = owner_species
				name = random
				skill = 3
				traits = {
					trait = leader_trait_adaptable
					trait = subclass_commander_general
				}
				effect = {
					add_trait = { trait = random_common }
					last_created_army = { assign_leader = prev }
				}
			}
			create_leader = {
				class = random_ruler
				species = owner_species
				name = random
				skill = 5
				effect = {
					add_trait = { trait = random_common }
					event_target:rebel_empire = { assign_leader = prev }
				}
			}
			establish_communications_no_message = root.owner
			if = {
				limit = { exists = event_target:new_owner_empire }
				establish_communications_no_message = event_target:new_owner_empire
			}
			event_target:old_owner = {
				every_relation = { establish_communications_no_message = prevprevprev }
			}
			event_target:rebel_planet = { # Flip the target planet
				set_owner = event_target:rebel_empire
				if = {
					limit = {
						root = { has_situation_flag = slave_revolt }
					}
					add_modifier = {
						modifier = free_at_last
						clear_on_owner_change = yes
						years = 20
					}
				}
				else = {
					add_modifier = {
						modifier = insurgents_free
						clear_on_owner_change = yes
						years = 20
					}
				}
				solar_system = {
					if = {
						limit = { exists = starbase }
						starbase = {
							if = {
								limit = { is_owned_by = root.owner }
								set_owner = event_target:rebel_empire
								if = {
									limit = { has_starbase_size = starbase_outpost }
									set_starbase_size = starbase_starport
									set_starbase_module = { slot = 1 module = shipyard }
									set_starbase_module = { slot = 2 module = shipyard }
								}
								else_if = {
									limit = {
										NOT = { has_starbase_module = shipyard }
									}
									set_starbase_module = { slot = 1 module = shipyard }
									set_starbase_module = { slot = 2 module = shipyard }
								}
							}
						}
					}
					else = {
						create_starbase = {
							size = starbase_starport
							module = shipyard
							module = shipyard
							owner = event_target:rebel_empire
						}
					}
					add_claims = { who = root.owner show_notification = no }
					every_system_colony = {
						limit = {
							has_owner = yes
							NOT = { is_planet = event_target:rebel_planet }
							is_owned_by = root.owner
						}
						set_owner = event_target:rebel_empire
					}
					every_fleet_in_system = {
						limit = {
							is_owned_by = root.owner
							can_go_mia = yes
						}
						set_mia = mia_return_home
					}
				}
				clear_variable = rebel_armies_var
			}
			root.owner = {
				every_owned_planet = { # Flip the additional joiner planets
					limit = {
						has_modifier = instability_join_revolt
						planet_stability < @[ stabilitylevel2 + stabilitylevel1 ]
						OR = {
							NOT = { exists = starbase }
							starbase = { is_owned_by = root.owner }
						}
						has_ground_combat = no
						has_orbital_bombardment = no
					}
					if = { # If you check this in the original limit of every_owned_planet, it calcs it before the loop is executed. Which means it will set the owner of the system twice if there are two colonies in the system.
						limit = {
							is_occupied_flag = no
							exists = controller
							controller = { is_same_empire = root.owner }
						}
						remove_modifier = instability_join_revolt
						set_owner = event_target:rebel_empire
						if = {
							limit = {
								root = { has_situation_flag = slave_revolt }
							}
							add_modifier = {
								modifier = free_at_last
								clear_on_owner_change = yes
								years = 20
							}
						}
						else = {
							add_modifier = {
								modifier = insurgents_free
								clear_on_owner_change = yes
								years = 20
							}
						}
						solar_system = {
							if = {
								limit = { exists = starbase }
								starbase = { set_owner = event_target:rebel_empire }
							}
							add_claims = { who = root.owner show_notification = no }
							every_system_colony = {
								limit = {
									has_owner = yes
									NOT = { is_planet = prevprev }
									is_owned_by = root.owner
								}
								set_owner = event_target:rebel_empire
							}
							every_fleet_in_system = {
								limit = {
									is_owned_by = root.owner
									can_go_mia = yes
								}
								set_mia = mia_return_home
							}
						}
					}
				}
			}
			every_system_within_border = { # Add a few systems
				every_neighbor_system = {
					limit = {
						has_owner = yes
						is_owned_by = root.owner
						exists = starbase
						NOR = {
							starbase = {
								OR = {
									is_starbase_type = sfortress
									NOT = { is_owned_by = root.owner }
								}
							}
							count_system_colony = { count > 0 }
						}
					}
					starbase = { set_owner = event_target:rebel_empire }
					add_claims = { who = root.owner show_notification = no }
					every_fleet_in_system = {
						limit = {
							is_owned_by = root.owner
							can_go_mia = yes
						}
						set_mia = mia_return_home
					}
				}
			}
			while = { # Get rid of bordergore systems
				limit = { # Note: system_within_border caching is quite funky at a time like this when many borders are changing hands. The starbase ownership is checked to be extra sure, since it is not cached (unlike system ownership - though that probably would have worked too)
					root.owner = {
						any_system_within_border = {
							exists = starbase
							starbase.owner = { is_same_empire = prevprev }
							count_neighbor_system = {
								count >= 2
								limit = {
									exists = starbase.owner
									starbase.owner = { is_same_empire = event_target:rebel_empire }
								}
							}
							NOR = {
								starbase = { is_starbase_type = sfortress }
								count_system_colony = { count > 0 }
							}
						}
					}
				}
				root.owner = {
					every_system_within_border = {
						limit = {
							exists = starbase
							starbase.owner = { is_same_empire = prevprev }
							count_neighbor_system = {
								count >= 2
								limit = {
									exists = starbase.owner
									starbase.owner = { is_same_empire = event_target:rebel_empire }
								}
							}
							NOR = {
								starbase = { is_starbase_type = sfortress }
								count_system_colony = { count > 0 }
							}
						}
						starbase = { set_owner = event_target:rebel_empire }
						add_claims = { who = root.owner show_notification = no }
						every_fleet_in_system = {
							limit = {
								is_owned_by = root.owner
								can_go_mia = yes
							}
							set_mia = mia_return_home
						}
					}
				}
			}
			if = {
				limit = { exists = event_target:new_owner_empire }
				set_country_flag = silence_destroy_event
				ruler = { save_event_target_as = exiled_rebel exile_leader_as = exiled_rebel }
				every_owned_starbase = { set_owner = event_target:new_owner_empire }
				every_owned_planet = {
					set_owner = event_target:new_owner_empire
					if = {
						limit = {
							root = { has_situation_flag = slave_revolt }
						}
						add_modifier = {
							modifier = slaves_defected
							clear_on_owner_change = yes
							years = 20
						}
					}
				}
				country_event = { id = unrest.4220 }
			}
			else = {
				add_resource = {
					minerals = 15000
					energy = 15000
					food = 15000
					consumer_goods = 10000
					alloys = 10000
					rare_crystals = 1000
					volatile_motes = 1000
					exotic_gases = 1000
					influence = 1000
					unity = 10000
				}
				# It copies the traditions and technologies in code
				create_fleet_from_naval_cap = 0.8
				set_timed_country_flag = { flag = cc_rebel_ethic_sorted days = 14 }
				fire_on_action = { on_action = empire_init_create_ships }
			}
		}
	}
	option = {
		name = unrest.4200.A
		trigger = {
			NOT = { exists = event_target:new_owner_empire }
		}
		event_target:rebel_empire = {
			declare_war = {
				target = root.owner
				attacker_war_goal = wg_ccrebel_independence
				name = { key = NAME_WAR_OF_REVOLT variable_string = "[Root.Target.GetName]" }
			}
		}
		ai_chance = {
			factor = 5
			mult = value:revolt_fleet_comparison_factor
		}
	}
	option = {
		name = unrest.4200.B
		custom_tooltip = unrest.4200.default_tooltip
		trigger = {
			NOT = { exists = event_target:new_owner_empire }
		}
		hidden_effect = {
			# Add truce
			event_target:rebel_empire = {
				set_truce = { target = root.owner type = liberation }
			}
			root.owner = {
				set_truce = { target = event_target:rebel_empire type = liberation }
			}
		}
		ai_chance = {
			factor = 1
			modifier = {
				factor = 2.0
				owner = { is_pacifist = yes }
			}
			modifier = {
				factor = 10
				owner = {
					is_at_war = yes
					any_relation = {
						is_at_war_with = prev
						relative_power = {
							who = prev
							value >= superior
							category = fleet
						}
					}
				}
			}
		}
	}
	option = {
		name = UNFORTUNATE
		custom_tooltip = unrest.4200.joiner_tooltip
		trigger = {
			exists = event_target:new_owner_empire
			owner = { is_at_war_with = event_target:new_owner_empire }
		}
	}
	option = {
		name = unrest.4200.A
		trigger = {
			exists = event_target:new_owner_empire
			NOT = { owner = { is_at_war_with = event_target:new_owner_empire } }
		}
		custom_tooltip = unrest.4200.joiner_tooltip
		event_target:new_owner_empire = {
			declare_war = {
				target = root.owner
				attacker_war_goal = wg_humiliation
				name = { key = NAME_WAR_OF_REVOLT variable_string = "[Root.Target.GetName]" }
			}
		}
		ai_chance = {
			factor = 1
			modifier = {
				factor = 0 # They can't take them on
				count_potential_war_participants = {
					attacker = event_target:new_owner_empire
					defender = root.owner
					side = event_target:new_owner_empire
					limit = {
						relative_power = { # Stronger than root.owner
							who = root.owner
							value >= superior
							category = fleet
						}
						count_potential_war_participants = { # And stronger than root.owner's allies
							attacker = event_target:new_owner_empire
							defender = root.owner
							side = root.owner
							limit = {
								relative_power = {
									who = prev
									value >= equivalent
									category = fleet
								}
							}
							count = 0
						}
					}
					count > 0
				}
			}
			modifier = { # These come into play when the empires are equivalent
				factor = 1.5
				owner = { is_militarist = yes }
			}
			modifier = {
				factor = 0.5
				owner = { is_pacifist = yes }
			}
		}
	}
	option = {
		name = unrest.4200.B
		trigger = {
			exists = event_target:new_owner_empire
			NOT = { owner = { is_at_war_with = event_target:new_owner_empire } }
		}
		custom_tooltip = unrest.4200.joiner_tooltip
		owner = {
			set_truce = { target = event_target:new_owner_empire type = liberation }
			hidden_effect = {
				event_target:new_owner_empire = {
					set_truce = { target = prev type = liberation }
				}
			}
		}
		ai_chance = {
			factor = 1
			modifier = {
				factor = 0 # They can definitely take them on
				count_potential_war_participants = {
					attacker = event_target:new_owner_empire
					defender = root.owner
					side = event_target:new_owner_empire
					limit = {
						relative_power = { # Stronger than root.owner
							who = root.owner
							value >= equivalent
							category = fleet
						}
					}
					count = 0
				}
			}
		}
	}
	after = {
		if = {
			limit = { exists = event_target:rebel_empire }
			event_target:rebel_empire = {
				if = {
					limit = { has_origin = origin_default }
					if = {
						limit = {
							root.owner = { has_origin = origin_tree_of_life }
							has_trait = trait_hive_mind
						}
						set_origin = origin_tree_of_life
					}
					else = {
						set_origin = origin_separatists
					}
				}
			}
		}
		if = { # Empire can lost its last planet this way
			limit = { is_scope_valid = yes }
			hidden_effect = {
				cleanup_separatism_situation = yes
				destroy_situation = this
			}
		}
	}
}

# (on_rebels_take_planet) removed in v3.6
# Make secessionists join a similar country even if it isn't the original owner (if it isn't the one they revolted from)
# Also avoid two 'free at last' modifiers
# In v3.4 replaced with situation_event = { id = unrest.4200
# This = Rebel Country
# From = Planet
country_event = {
	id = unrest.4210
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		has_country_flag = standard_unrest_rebels
	}

	immediate = {
		save_event_target_as = rebel_empire
		from = {
			remove_planet_flag = revolt_in_progress
			save_event_target_as = rebel_planet
			solar_system = {
				if = {
					limit = { exists = starbase }
					starbase = { set_owner = root }
				}
				add_claims = {
					who = from.owner
					num_of_claims = 1
					show_notification = no
				}
			}
		}
		create_leader = {
			class = random_ruler
			species = owner_species
			name = random
			skill = 2
		}
		assign_leader = last_created_leader
		ruler = {
			add_trait = { trait = random_common }
			save_event_target_as = exiled_rebel
		}
		from.owner = {
			save_event_target_as = rebelled_against
			save_event_target_as = old_owner # vanilla
			country_event = { id = unrest.4211 }
		}
		from = {
			if = {
				limit = { has_modifier = free_at_last }
				remove_modifier = free_at_last
			}
			if = {
				limit = { has_modifier = insurgents_free }
				remove_modifier = insurgents_free
			}
			if = {
				limit = { has_modifier = slaves_defected }
				remove_modifier = slaves_defected
			}
			if = {
				limit = { has_planet_flag = slave_revolt }
				add_modifier = {
					modifier = free_at_last
					clear_on_owner_change = yes
					years = 20
				}
				remove_planet_flag = slave_revolt
			}
			else = {
				add_modifier = {
					modifier = insurgents_free
					clear_on_owner_change = yes
					years = 20
				}
			}
		}
		if = {
			limit = {
				from = { has_planet_flag = nationalist_revolt }
			}
			from = { remove_planet_flag = nationalist_revolt }
			if = {
				limit = {
					any_playable_country = {
						has_communications = root
						is_same_species = root
						NOR = {
							has_country_flag = ccrebel_has_existed_5_years
							is_same_empire = root
							is_same_empire = from.owner
							has_country_flag = cc_rebels_merging
							would_join_war = {
								attacker = root
								defender = from.owner
								side = from.owner
							}
						}
					}
				}
				random_playable_country = {
					limit = {
						has_communications = root
						is_same_species = root
						NOR = {
							has_country_flag = ccrebel_has_existed_5_years
							is_same_empire = root
							is_same_empire = from.owner
							has_country_flag = cc_rebels_merging
							would_join_war = {
								attacker = root
								defender = from.owner
								side = from.owner
							}
						}
					}
					save_event_target_as = fatherland
				}
			}
			else = {
				if = {
					limit = {
						any_playable_country = {
							has_communications = root
							is_same_species = root
							NOR = {
								is_same_empire = root
								is_same_empire = from.owner
								would_join_war = {
									attacker = root
									defender = from.owner
									side = from.owner
								}
							}
							from = { is_original_owner = prev }
						}
					}
					random_playable_country = {
						limit = {
							has_communications = root
							is_same_species = root
							NOR = {
								is_same_empire = root
								is_same_empire = from.owner
								would_join_war = {
									attacker = root
									defender = from.owner
									side = from.owner
								}
							}
							from = { is_original_owner = prev }
						}
						save_event_target_as = fatherland
					}
				}
				if = {
					limit = {
						NOT = { exists = event_target:fatherland }
						any_playable_country = {
							has_communications = root
							is_same_species = root
							NOR = {
								is_same_empire = root
								is_same_empire = from.owner
								would_join_war = {
									attacker = root
									defender = from.owner
									side = from.owner
								}
								has_country_flag = cc_rebels_merging
								has_country_flag = cc_chain_revolt
							}
						}
					}
					random_playable_country = {
						limit = {
							has_communications = root
							is_same_species = root
							any_owned_planet = {
								distance = {
									source = from
									max_distance <= 150
									min_distance >= 0
								}
							}
							NOR = {
								is_same_empire = root
								is_same_empire = from.owner
								would_join_war = {
									attacker = root
									defender = from.owner
									side = from.owner
								}
								has_country_flag = cc_rebels_merging
								has_country_flag = cc_chain_revolt
							}
						}
						save_event_target_as = fatherland
					}
				}
				if = {
					limit = {
						NOT = { exists = event_target:fatherland }
					}
					random_playable_country = {
						limit = {
							has_communications = root
							is_same_species = root
							any_owned_planet = {
								distance = {
									source = from
									max_distance <= 150
									min_distance >= 0
								}
							}
							NOR = {
								is_same_empire = from.owner
								is_same_empire = root
								would_join_war = {
									attacker = root
									defender = from.owner
									side = from.owner
								}
								has_country_flag = cc_rebels_merging
							}
						}
						save_event_target_as = fatherland
					}
				}
			}
			if = {
				limit = { exists = event_target:fatherland }
				if = {
					limit = {
						event_target:fatherland = {
							OR = {
								NOT = { has_country_flag = ccrebel_has_existed_5_years }
								is_at_war_with = from.owner
								# This is sadly necessary
								has_federation = yes
							}
						}
					}
					set_timed_country_flag = { flag = ccrebel_dont_declare_war days = 5 }
					set_country_flag = cc_rebels_merging
					event_target:fatherland = {
						country_event = { id = unrest.4220 days = 5 }						# Request incorporation
					}
				}
				else = {
					event_target:fatherland = {
						country_event = { id = ccrebel_wg_script.10 days = 5 }						# Request support in independence war
					}
				}
			}
		}
		else = {
			from = { remove_planet_flag = secessionist_revolt }
		}
	}
}

# Rebels have broken free notification
country_event = {
	id = unrest.4211
	title = unrest.4211.name
	desc = {
		trigger = { is_gestalt = yes }
		text = unrest.4211.desc
	}
	desc = {
		trigger = { is_gestalt = yes }
		text = unrest.4211.desc.gesta
	}
	picture = {
		picture = GFX_evt_arguing_senate
		trigger = { is_gestalt = no }
	}
	picture = {
		picture = GFX_evt_satellite_in_orbit
		trigger = { is_gestalt = yes }
	}

	show_sound = event_factions
	location = fromfrom
	is_triggered_only = yes
	option = {
		name = UNFORTUNATE
	}
}

# Notification for joiner empire
# Add a new line to stop errors being thrown up if it triggers multiple times for the same revolt + one to stop it from being destroyed if the country got annexed in the meantime
# on_rebels_take_planet: Initial rebels manage to take control of the planet, happens before the new owner is set, after the war is created.
# This = Fatherland Country
# From = Rebel Country
# fromfrom = Planet
country_event = {
	id = unrest.4220
	title = unrest.4220.name
	desc = {
		trigger = {
			OR = {
				is_regular_empire = yes
				AND = {
					exists = event_target:rebel_planet
					event_target:rebel_planet = { is_original_owner = root }
				}
			}
		}
		text = unrest.4220.desc
	}
	desc = {
		trigger = {
			exists = event_target:rebel_planet
			NOT = { event_target:rebel_planet = { is_original_owner = root } }
		}
		text = unrest.4220.desc.not_orowner
	}
	desc = {
		text = unrest.4220.desc.hive
		trigger = { is_machine_empire = yes }
	}
	desc = {
		text = unrest.4220.desc.machine
		trigger = { is_hive_empire = yes }
	}

	location = event_target:rebel_planet
	diplomatic = yes
	picture_event_data = {
		# portrait = from
		# planet_background = from.capital_scope
		# graphical_culture = from
		# city_level = from.capital_scope
		# room = from.ruler
		portrait = event_target:exiled_rebel
		planet_background = event_target:rebel_planet
		city_level = event_target:rebel_planet
		room = event_target:old_owner.ruler
	}
	trigger = {
		is_scope_valid = yes
		exists = event_target:rebel_empire
		NOT = { is_same_empire = event_target:rebel_empire }
	}

	is_triggered_only = yes
	option = {
		name = unrest.4220.b
		ai_chance = { factor = 100 }
		event_target:rebel_empire = {
			every_owned_starbase = { set_owner = root }
			every_owned_planet = {
				set_timed_planet_flag = { flag = ccrebel_rebellion_transfer days = 5 }
				set_owner = root
				hidden_effect = {
					if = {
						limit = { has_modifier = free_at_last }
						remove_modifier = free_at_last
					}
					if = {
						limit = { has_modifier = insurgents_free }
						remove_modifier = insurgents_free
					}
					if = {
						limit = { has_modifier = slaves_defected }
						remove_modifier = slaves_defected
					}
					if = {
						limit = { has_planet_flag = slave_revolt }
						add_modifier = {
							modifier = free_at_last
							clear_on_owner_change = yes
							years = 20
						}
						remove_planet_flag = slave_revolt
					}
					else = {
						add_modifier = {
							modifier = insurgents_free
							clear_on_owner_change = yes
							years = 20
						}
					}
				}
			}
			hidden_effect = {
				set_country_flag = silence_destroy_event
				destroy_country = yes
			}
		}
		hidden_effect = {
			if = {
				limit = { has_country_flag = cc_rebellion }
				set_timed_country_flag = { flag = cc_rebellion years = 1 }
			}
			if = {
				limit = { exists = event_target:old_owner }
				event_target:old_owner = {
					country_event = { id = unrest.4230 days = 5 }					# Were annexed notification
				}
			}
		}
	}
	option = {
		name = unrest.4220.a
		trigger = { is_subject = no }
		ai_chance = { factor = 0 }
		event_target:rebel_empire = {
			set_subject_of = { who = root preset = preset_vassal }
		}
		hidden_effect = {
			if = {
				limit = { exists = event_target:old_owner }
				event_target:old_owner = {
					country_event = { id = unrest.4225 }					# Became vassal notification
				}
			}
		}
	}
	option = {
		name = unrest.4220.c
		hidden_effect = {
			if = {
				limit = {
					any_relation = {
						is_country_type_with_subjects = yes
						has_relation_flag = { who = event_target:rebel_empire flag = ccrebel_declare_war_on }
						NOT = { is_at_war_with = event_target:rebel_empire }
					}
				}
				random_relation = {
					limit = {
						is_country_type_with_subjects = yes
						has_relation_flag = { who = event_target:rebel_empire flag = ccrebel_declare_war_on }
						NOT = { is_at_war_with = event_target:rebel_empire }
					}
					save_event_target_as = ccrebel_declared_war_on
					event_target:rebel_empire = {
						declare_war = { target = prev attacker_war_goal = wg_ccrebel_independence }
					}
				}
			}
		}
		ai_chance = { factor = 0 }
	}
}

# (Vanilla)
country_event = {
	id = unrest.4225
	title = unrest.4225.name
	desc = {
		trigger = { is_gestalt = no }
		text = unrest.4225.desc
	}
	desc = {
		trigger = { is_gestalt = yes }
		text = unrest.4225.desc.gesta
	}
	picture = {
		picture = GFX_evt_arguing_senate
		trigger = { is_gestalt = no }
	}
	picture = {
		picture = GFX_evt_satellite_in_orbit
		trigger = { is_gestalt = yes }
	}

	show_sound = event_factions
	location = fromfromfrom
	is_triggered_only = yes
	option = {
		name = unrest.4225.a
		add_opinion_modifier = { modifier = opinion_took_in_rebels who = from }
	}
}

# (Vanilla)
country_event = {
	id = unrest.4230
	title = unrest.4230.name
	desc = {
		trigger = { is_gestalt = no }
		text = unrest.4230.desc
	}
	desc = {
		trigger = { is_gestalt = yes }
		text = unrest.4230.desc.gesta
	}
	picture = {
		picture = GFX_evt_arguing_senate
		trigger = { is_gestalt = no }
	}
	picture = {
		picture = GFX_evt_satellite_in_orbit
		trigger = { is_gestalt = yes }
	}

	show_sound = event_factions
	location = fromfromfrom
	is_triggered_only = yes

	trigger = {
		event_target:rebel_planet = {
			exists = controller
			controller = { is_same_empire = prev.owner }
		}
	}
	option = {
		name = unrest.4225.a
		add_opinion_modifier = { modifier = opinion_took_in_rebels who = from }
	}
}
